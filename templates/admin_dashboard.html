{% extends 'base.html' %}
{% load static %}

{% block title %}Skybiz- Admin Dashboard{% endblock %}

{% block content %}
<section id="admin-dashboard" class="py-16 bg-gray-100 dark:bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
            <div class="bg-{% if message.tags == 'success' %}green-100 text-green-700{% else %}red-100 text-red-700{% endif %} p-4 rounded-lg">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if user.is_authenticated and user.is_staff %}
        <!-- Dashboard Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-primary dark:text-secondary">Admin Dashboard</h1>
            <div class="flex space-x-4">
                <a href="{% url 'admin_panel' %}" class="bg-primary dark:bg-secondary text-white dark:text-primary px-4 py-2 rounded-lg hover:opacity-90 transition-opacity">
                    Manage Resources
                </a>
                <button onclick="document.getElementById('logoutModal').classList.remove('hidden')" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                    Logout
                </button>
            </div>
        </div>
        <!-- Metrics Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-primary dark:text-secondary">Total Users</h3>
                <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{ total_users }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Active: {{ active_users }}</p>
            </div>
            {% comment %} <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-primary dark:text-secondary">Users with Packages</h3>
                <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{ users_with_packages }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Subscribed users</p>
            </div> {% endcomment %}
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-primary dark:text-secondary">Total Packages</h3>
                <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{ total_packages }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Residential: {{ residential_packages }} | Business: {{ business_packages }}</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-primary dark:text-secondary">Speed Tests</h3>
                <p class="text-3xl font-bold text-gray-800 dark:text-gray-200">{{ speed_tests_total }}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Avg. Download: {{ avg_download_speed }} Mbps</p>
            </div>
        </div>

        <!-- Speed Test Chart -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-12">
            <h2 class="text-xl font-bold mb-4 text-primary dark:text-secondary">Average Download Speed (Last 7 Days)</h2>
            <canvas id="speedTestChart"></canvas>
        </div>

        <!-- Recent Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4 text-primary dark:text-secondary">Recent Contact Messages</h2>
                <div class="space-y-4">
                    {% for message in recent_messages %}
                    <div class="border-l-4 border-primary dark:border-secondary pl-4">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">{{ message.name }}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">{{ message.subject }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-500">{{ message.created_at|timesince }} ago</p>
                    </div>
                    {% empty %}
                    <p class="text-gray-600 dark:text-gray-400">No recent messages.</p>
                    {% endfor %}
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4 text-primary dark:text-secondary">Recent Business Requests</h2>
                <div class="space-y-4">
                    {% for request in recent_business_requests %}
                    <div class="border-l-4 border-primary dark:border-secondary pl-4">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">{{ request.company_name }}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">{{ request.contact_person }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-500">{{ request.created_at|timesince }} ago</p>
                    </div>
                    {% empty %}
                    <p class="text-gray-600 dark:text-gray-400">No recent requests.</p>
                    {% endfor %}
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4 text-primary dark:text-secondary">Recent Speed Tests</h2>
                <div class="space-y-4">
                    {% for result in recent_speed_tests %}
                    <div class="border-l-4 border-primary dark:border-secondary pl-4">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">{{ result.user.username|default:"Anonymous" }}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Download: {{ result.download_speed|floatformat:2 }} Mbps | 
                            Upload: {{ result.upload_speed|floatformat:2 }} Mbps | 
                            Latency: {{ result.latency|floatformat:2 }} ms
                        </p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">IP: {{ result.ip_address|default:"N/A" }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-500">{{ result.timestamp|timesince }} ago</p>
                    </div>
                    {% empty %}
                    <p class="text-gray-600 dark:text-gray-400">No recent speed tests.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Logout Modal -->
        <div id="logoutModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                <h2 class="text-xl font-bold mb-4 text-primary dark:text-secondary">Confirm Logout</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-6">Are you sure you want to log out?</p>
                <form method="POST" action="{% url 'dashboard' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="logout">
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="document.getElementById('logoutModal').classList.add('hidden')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                            Logout
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% else %}
        <!-- Login and Registration Forms -->
        <div class="max-w-md mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-primary dark:text-secondary text-center">Admin Login</h2>
            <form method="POST" action="{% url 'dashboard' %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="login">
                {{ login_form.as_p }}
                <button type="submit" class="w-full bg-primary dark:bg-secondary text-white dark:text-primary px-4 py-2 rounded-lg hover:bg-opacity-90 mt-4">
                    Login
                </button>
            </form>
            {% comment %} <p class="text-center text-gray-600 dark:text-gray-300 mt-4">
                Don't have an account? 
                <button onclick="document.getElementById('registerModal').classList.remove('hidden')" class="text-primary dark:text-secondary hover:underline">
                    Register
                </button>
            </p> {% endcomment %}
        </div>

        {% comment %} <!-- Registration Modal -->
        <div id="registerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                <h2 class="text-xl font-bold mb-4 text-primary dark:text-secondary">Register Admin Account</h2>
                <form method="POST" action="{% url 'dashboard' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="register">
                    {{ registration_form.as_p }}
                    <div class="flex justify-end space-x-4 mt-4">
                        <button type="button" onclick="document.getElementById('registerModal').classList.add('hidden')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" class="bg-primary dark:bg-secondary text-white dark:text-primary px-4 py-2 rounded-lg hover:bg-opacity-90">
                            Register
                        </button>
                    </div>
                </form>
            </div>
        </div> {% endcomment %}
        {% endif %}
    </div>
</section>

{% block scripts %}
{% if user.is_authenticated and user.is_staff %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('speedTestChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: 'Average Download Speed (Mbps)',
                data: {{ chart_data|safe }},
                fill: false,
                borderColor: '#3b82f6',
                backgroundColor: '#3b82f6',
                tension: 0.4
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Download Speed (Mbps)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Days'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });

    function editBranch(id, name, address, city, state, phone, email, is_active) {
        document.getElementById('branch_id').value = id;
        document.querySelector('input[name="name"]').value = name;
        document.querySelector('input[name="address"]').value = address;
        document.querySelector('input[name="city"]').value = city;
        document.querySelector('input[name="state"]').value = state;
        document.querySelector('input[name="phone"]').value = phone;
        document.querySelector('input[name="email"]').value = email;
        document.querySelector('input[name="is_active"]').checked = (is_active === 'true');
    }
</script>
{% endif %}
{% endblock scripts %}
{% endblock %}